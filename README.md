# Mermaid Flow Plugin

通过自然语言描述流程，生成 Mermaid 图表代码，预览后插入 Figma 画布为可编辑的矢量节点。

## 功能

- **自然语言生成**：输入流程描述（如「用户登录后选择产品，加入购物车，然后结账」），调用 LLM 生成 Mermaid 代码
- **实时预览**：在插件内实时渲染 Mermaid 图表
- **可编辑**：通过 `createNodeFromSvg` 插入为矢量节点，可在 Figma 中自由编辑
- **再次编辑**：选中已插入的流程图，在属性面板点击「编辑流程图」可修改 Mermaid 代码后重新插入

## 使用方法

1. 运行插件，在输入框中用自然语言描述你的流程
2. 点击「生成 Mermaid 代码」，等待 LLM 返回结果
3. 在代码区域可手动修改 Mermaid 语法
4. 预览满意后点击「插入到画布」

## API 设置

首次使用需配置 LLM API：

- 打开「API 设置」折叠面板
- 选择提供商：OpenAI / OpenRouter / Google Gemini / 自定义端点
- 填入 API Key 和模型名称
- 点击「保存设置」

**注意**：自定义端点需在 manifest 的 `networkAccess.allowedDomains` 中添加对应域名；发布版目前支持 OpenAI、OpenRouter、Google Gemini。

## Development guide

*This plugin is built with [Create Figma Plugin](https://yuanqing.github.io/create-figma-plugin/).*

### Pre-requisites

- [Node.js](https://nodejs.org) – v18
- [Figma desktop app](https://figma.com/downloads/)

### Build the plugin

To build the plugin:

```
$ npm run build
```

This will generate a [`manifest.json`](https://figma.com/plugin-docs/manifest/) file and a `build/` directory containing the JavaScript bundle(s) for the plugin.

To watch for code changes and rebuild the plugin automatically:

```
$ npm run watch
```

### Install the plugin

1. In the Figma desktop app, open a Figma document.
2. Search for and run `Import plugin from manifest…` via the Quick Actions search bar.
3. Select the `manifest.json` file that was generated by the `build` script.

### Debugging

**打开控制台**：在 Figma 中按 `Cmd/Ctrl + /` 打开 Quick Actions，搜索并运行 `Open Console`，可查看主线程 (main) 的日志。

**调试 UI (iframe)**：插件 UI 运行在 iframe 中，需在 iframe 的上下文中调试：
- 运行插件后，在控制台切换到 iframe 的 context（控制台顶部的下拉菜单选择 `create-figma-plugin` 或类似条目）
- 或在主控制台用 `document.querySelector('iframe')` 获取 iframe 后，通过 iframe 的 contentWindow 访问

**常用调试手段**：
- `console.log` / `console.error`：主线程和 UI 均可使用
- 在 `main.ts` 的 `catch` 中加入 `console.error(err)` 查看完整错误
- 使用 `npm run watch` 修改代码后自动重新构建，再在 Figma 中重新运行插件

## See also

- [Create Figma Plugin docs](https://yuanqing.github.io/create-figma-plugin/)
- [`yuanqing/figma-plugins`](https://github.com/yuanqing/figma-plugins#readme)

Official docs and code samples from Figma:

- [Plugin API docs](https://figma.com/plugin-docs/)
- [`figma/plugin-samples`](https://github.com/figma/plugin-samples#readme)
